name: Generar archivo YAML de Secret desde HCP Vault Secrets

on:
  workflow_dispatch:

jobs:
  generar-secret-yaml:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Obtener access token desde HCP Vault (Service Principal)
        id: auth
        run: |
          TOKEN=$(curl --silent --location "https://auth.idp.hashicorp.com/oauth2/token" \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${{ secrets.HCP_CLIENT_ID }}" \
            --data-urlencode "client_secret=${{ secrets.HCP_CLIENT_SECRET }}" \
            --data-urlencode "grant_type=client_credentials" \
            --data-urlencode "audience=https://api.hashicorp.cloud" | jq -r '.access_token')

          echo "HCP_API_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Leer y mostrar secretos sin procesar
        run: |
          echo " Obteniendo token temporal de HCP..."
          HCP_API_TOKEN=$(curl --silent --location "https://auth.idp.hashicorp.com/oauth2/token" \
          --header "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "client_id=${{ secrets.HCP_CLIENT_ID }}" \
          --data-urlencode "client_secret=${{ secrets.HCP_CLIENT_SECRET }}" \
          --data-urlencode "grant_type=client_credentials" \
          --data-urlencode "audience=https://api.hashicorp.cloud" | jq -r .access_token)

          echo "üîç Obteniendo secretos de sample-app..."
          curl --location "https://api.cloud.hashicorp.com/secrets/2023-11-28/organizations/09b95cd0-d483-4255-93fb-8e35c1dbfae5/projects/c2251c51-0cf9-4989-ba00-d9794140dc2b/apps/sample-app/secrets:open" \
          --header "Authorization: Bearer $HCP_API_TOKEN"


      - name: Mostrar YAML generado
        run: cat singlestore-secret.yaml

      - name: Guardar YAML como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: singlestore-secret
          path: singlestore-secret.yaml
